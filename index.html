<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snakes & Ladders</title>
    <style>
        /* CORE RESET & BASE STYLES */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #eef2ff;
            color: #1e293b;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        /* TOP BAR */
        header {
            background: #ffffff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            z-index: 200;
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .game-icon { background: #3b82f6; color: white; padding: 6px 10px; border-radius: 8px; font-weight: 900; }
        .title { font-size: 1.25rem; font-weight: 800; color: #1e293b; margin: 0; }
        .reset-icon { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; border-radius: 50%; }
        .reset-icon:hover { background: #f1f5f9; }

        /* MAIN AREA */
        main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* SETUP SCREEN */
        #setup-screen {
            background: white;
            width: 100%;
            max-width: 450px;
            padding: 24px;
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            z-index: 300;
        }
        .setup-list { margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .player-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8fafc;
            padding: 10px;
            border-radius: 16px;
            border: 2px solid #f1f5f9;
        }
        .avatar-select {
            width: 60px;
            height: 44px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            font-size: 20px;
            cursor: pointer;
        }
        .player-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 700;
            outline: none;
            color: #334155;
            min-width: 0;
        }
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 900;
            margin-right: 4px;
        }
        .badge-ai { background: #fef3c7; color: #b45309; }
        .badge-human { background: #dcfce7; color: #166534; }
        
        .btn-del {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }

        .setup-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .btn-secondary {
            background: #f1f5f9;
            border: 2px dashed #cbd5e1;
            padding: 12px;
            border-radius: 12px;
            color: #475569;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-start {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 18px;
            font-size: 1.2rem;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .btn-start:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        .validation-msg { color: #ef4444; font-size: 0.8rem; font-weight: 700; margin-top: 8px; }

        /* GAME BOARD AREA */
        #game-screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* Central Status Indicator */
        .status-banner {
            background: white;
            padding: 10px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
            z-index: 100;
        }
        .status-icon { font-size: 24px; }
        .status-text { font-weight: 800; font-size: 1.1rem; }

        .board-container {
            position: relative;
            /* Scale reduced to prevent overlap with corner buttons */
            --board-size: min(70vw, 70vh, 700px);
            width: var(--board-size);
            height: var(--board-size);
            background: #fefce8;
            border: 5px solid #000000;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 10;
        }
        #game-board {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
        }
        .cell {
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 900;
            color: #475569;
            position: relative;
        }
        .cell:nth-child(even) { background: #fdfae1; }
        .cell-100 { background: #7e22ce !important; color: white !important; font-size: 28px; }
        .cell-ladder-start { background: #dcfce7 !important; }
        .cell-snake-start { background: #fee2e2 !important; }

        .sl-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* TOKENS */
        .token {
            position: absolute;
            width: 8%;
            height: 12%;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            z-index: 20;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        .token-emoji { font-size: 40px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .token-name {
            font-size: 11px;
            font-weight: 900;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 6px;
            margin-top: 2px;
            white-space: nowrap;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }

        /* CORNER CONTROLS */
        .corner-btn {
            position: fixed;
            width: 200px;
            height: 110px;
            padding: 12px;
            border-radius: 25px;
            border: none;
            background: #ffffff;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            transition: all 0.2s;
        }
        .corner-btn:active { transform: scale(0.92); }
        .corner-btn.active { 
            background: #2563eb; 
            color: white; 
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.5);
            animation: pulse-border 1.5s infinite;
        }
        /* ENHANCED DISABLED STATE VISIBILITY */
        .corner-btn:disabled { 
            opacity: 1; 
            cursor: not-allowed; 
            background: #64748b; /* DARK GRAY FOR BETTER VISIBILITY */
            color: #ffffff; /* WHITE TEXT */
        }
        .corner-btn .p-label { font-size: 11px; font-weight: 900; opacity: 0.9; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .corner-btn .p-name { font-size: 15px; font-weight: 800; line-height: 1.2; text-align: center; }

        @keyframes pulse-border {
            0% { box-shadow: 0 10px 30px rgba(37, 99, 235, 0.5); }
            50% { box-shadow: 0 10px 50px rgba(37, 99, 235, 0.8); }
            100% { box-shadow: 0 10px 30px rgba(37, 99, 235, 0.5); }
        }

        /* Corner Positions Adjusted to avoid Header Overlap */
        .pos-0 { bottom: 25px; left: 25px; }
        .pos-1 { bottom: 25px; right: 25px; }
        .pos-2 { top: 100px; right: 25px; } /* MOVED DOWN */
        .pos-3 { top: 100px; left: 25px; }  /* MOVED DOWN */

        /* DICE OVERLAY */
        #dice-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }
        .dice-container {
            background: white;
            padding: 40px;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            text-align: center;
            border: 8px solid #000;
        }
        .dice-face { font-size: 100px; margin-bottom: 15px; }
        .dice-shaking { animation: shake 0.1s infinite; }
        @keyframes shake {
            0% { transform: translate(2px, 2px) rotate(0deg); }
            25% { transform: translate(-2px, 1px) rotate(5deg); }
            50% { transform: translate(-1px, -2px) rotate(0deg); }
            75% { transform: translate(1px, 2px) rotate(-5deg); }
            100% { transform: translate(2px, 1px) rotate(0deg); }
        }

        .win-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .win-title { font-size: 4rem; font-weight: 900; margin-bottom: 20px; color: #fbbf24; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="game-icon">S&L</div>
            <h1 class="title">Snakes & Ladders</h1>
        </div>
        <button class="reset-icon" id="btn-reload" title="Restart Game">üîÑ</button>
    </header>

    <main>
        <!-- SETUP -->
        <div id="setup-screen">
            <h2 style="margin-top:0; color:#1e293b;">Let's Play!</h2>
            <div id="setup-list" class="setup-list"></div>
            
            <div class="setup-actions">
                <button id="btn-add-human" class="btn-secondary">+ Add Human</button>
                <button id="btn-add-ai" class="btn-secondary">+ Add AI Player</button>
            </div>

            <button id="btn-start-game" class="btn-start">START GAME</button>
            <div id="validation-msg" class="validation-msg"></div>
        </div>

        <!-- GAME BOARD AREA -->
        <div id="game-screen">
            <!-- Turn Indicator Bar -->
            <div id="current-turn-banner" class="status-banner">
                <span id="turn-banner-icon" class="status-icon">ü¶ñ</span>
                <span id="turn-banner-text" class="status-text">Adit's Turn</span>
            </div>

            <div class="board-container">
                <div id="game-board"></div>
                <svg id="sl-canvas" class="sl-layer"></svg>
                <div id="tokens-layer"></div>
                
                <div id="dice-overlay">
                    <div class="dice-container">
                        <div id="dice-visual" class="dice-face">üé≤</div>
                        <div id="dice-msg" style="font-weight: 900; color: #3b82f6; font-size: 1.5rem;">ROLLING...</div>
                    </div>
                </div>
            </div>

            <!-- Corner Buttons -->
            <button id="roll-btn-0" class="corner-btn pos-0"><div class="p-label">PLAYER 1</div><div class="p-name">ROLL DICE</div></button>
            <button id="roll-btn-1" class="corner-btn pos-1"><div class="p-label">PLAYER 2</div><div class="p-name">ROLL DICE</div></button>
            <button id="roll-btn-2" class="corner-btn pos-2"><div class="p-label">PLAYER 3</div><div class="p-name">ROLL DICE</div></button>
            <button id="roll-btn-3" class="corner-btn pos-3"><div class="p-label">PLAYER 4</div><div class="p-name">ROLL DICE</div></button>
        </div>
    </main>

    <div id="win-overlay" class="win-overlay">
        <div style="font-size: 120px;">üéâüèÜüéâ</div>
        <div id="win-text" class="win-title">Adit Wins!</div>
        <button class="btn-start" style="width: 300px; margin-top: 30px;" onclick="location.reload()">NEW GAME</button>
    </div>

    <script>
        const EMOJIS = ['ü¶ñ', 'ü¶Å', 'ü¶ä', 'üêº', 'üê®', 'üê∏', 'ü¶Ñ', 'üê±', 'üê∂', 'üêØ', 'üêµ', 'üê∑', 'üêß', 'ü¶â', 'üêù', 'üê¢', 'üêô', 'üëæ', 'üöÄ', 'üåà'];
        const AI_NAMES = ['Tom', 'Amy', 'Sam', 'Ziggy', 'Pixel', 'Turbo', 'Ace', 'Spark', 'Misty', 'Bo', 'Rocky', 'Luna'];
        const DICE_CHARS = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
        
        const LADDERS = { 4: 14, 9: 31, 20: 38, 28: 76, 40: 59, 51: 67, 63: 81, 71: 91 };
        const SNAKES = { 17: 7, 54: 34, 62: 18, 64: 60, 87: 24, 93: 73, 98: 56 };

        let players = [];
        let currentPlayerIndex = 0;
        let isMoving = false;

        // --- SETUP SCREEN LOGIC ---

        function addPlayerRow(type, defaultName, defaultEmoji) {
            const list = document.getElementById('setup-list');
            if (list.children.length >= 4) return;

            const div = document.createElement('div');
            div.className = 'player-row';
            div.dataset.type = type;

            const emojiSelect = document.createElement('select');
            emojiSelect.className = 'avatar-select';
            const startEmoji = defaultEmoji || EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            EMOJIS.forEach((emoji) => {
                const opt = document.createElement('option');
                opt.value = emoji; opt.textContent = emoji;
                if (emoji === startEmoji) opt.selected = true;
                emojiSelect.appendChild(opt);
            });

            const badge = document.createElement('span');
            badge.className = `badge badge-${type}`;
            badge.textContent = type.toUpperCase();

            const input = document.createElement('input');
            input.type = 'text'; input.className = 'player-input';
            
            if (!defaultName) {
                if (type === 'ai') {
                    input.value = `AI-${AI_NAMES[Math.floor(Math.random() * AI_NAMES.length)]}`;
                } else {
                    const humanCount = Array.from(list.children).filter(r => r.dataset.type === 'human').length + 1;
                    input.value = `Player ${humanCount}`;
                }
            } else {
                input.value = defaultName;
            }

            const delBtn = document.createElement('button');
            delBtn.className = 'btn-del'; delBtn.innerHTML = '&times;';
            delBtn.onclick = () => { div.remove(); validateSetup(); };

            div.appendChild(emojiSelect); div.appendChild(badge); div.appendChild(input); div.appendChild(delBtn);
            list.appendChild(div);
            validateSetup();
        }

        function validateSetup() {
            const list = document.getElementById('setup-list');
            const startBtn = document.getElementById('btn-start-game');
            const msg = document.getElementById('validation-msg');
            const count = list.children.length;
            startBtn.disabled = count < 2;
            msg.textContent = count < 2 ? "Add at least 2 players!" : "";
            document.getElementById('btn-add-human').disabled = count >= 4;
            document.getElementById('btn-add-ai').disabled = count >= 4;
        }

        document.getElementById('btn-add-human').onclick = () => addPlayerRow('human');
        document.getElementById('btn-add-ai').onclick = () => addPlayerRow('ai');

        addPlayerRow('human', 'Adit', 'ü¶ñ');
        addPlayerRow('ai');

        // --- GAME LOGIC ---

        function generateBoard() {
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            for (let r = 9; r >= 0; r--) {
                const isEvenRow = r % 2 === 0;
                for (let c = 0; c < 10; c++) {
                    const col = isEvenRow ? c : (9 - c);
                    const num = (r * 10) + col + 1;
                    const cell = document.createElement('div');
                    let extraClass = '';
                    if (num === 100) extraClass = 'cell-100';
                    else if (LADDERS[num]) extraClass = 'cell-ladder-start';
                    else if (SNAKES[num]) extraClass = 'cell-snake-start';
                    cell.className = `cell ${extraClass}`;
                    cell.id = `c${num}`;
                    cell.textContent = num;
                    board.appendChild(cell);
                }
            }
            setTimeout(drawGraphics, 200);
        }

        function getCellData(num) {
            const cell = document.getElementById('c' + num);
            const board = document.getElementById('game-board');
            if (!cell || !board) return null;
            const cRect = cell.getBoundingClientRect();
            const bRect = board.getBoundingClientRect();
            return {
                x: (cRect.left - bRect.left) + cRect.width / 2,
                y: (cRect.top - bRect.top) + cRect.height / 2,
                left: cRect.left - bRect.left,
                top: cRect.top - bRect.top,
                w: cRect.width, h: cRect.height
            };
        }

        function drawGraphics() {
            const svg = document.getElementById('sl-canvas');
            const board = document.getElementById('game-board');
            if (!board) return;
            svg.setAttribute('width', board.offsetWidth);
            svg.setAttribute('height', board.offsetHeight);
            svg.innerHTML = '';

            const createSVG = (tag) => document.createElementNS("http://www.w3.org/2000/svg", tag);

            for (let [s, e] of Object.entries(LADDERS)) {
                const start = getCellData(s); const end = getCellData(e);
                if (!start || !end) continue;
                const dx = end.x - start.x; const dy = end.y - start.y;
                const angle = Math.atan2(dy, dx);
                const px = -Math.sin(angle) * 10; const py = Math.cos(angle) * 10;
                const r1 = createSVG("line"); r1.setAttribute("x1", start.x + px); r1.setAttribute("y1", start.y + py); r1.setAttribute("x2", end.x + px); r1.setAttribute("y2", end.y + py);
                r1.setAttribute("stroke", "#8b4513"); r1.setAttribute("stroke-width", "5"); svg.appendChild(r1);
                const r2 = createSVG("line"); r2.setAttribute("x1", start.x - px); r2.setAttribute("y1", start.y - py); r2.setAttribute("x2", end.x - px); r2.setAttribute("y2", end.y - py);
                r2.setAttribute("stroke", "#8b4513"); r2.setAttribute("stroke-width", "5"); svg.appendChild(r2);
                const rungs = 8;
                for (let i = 1; i < rungs; i++) {
                    const t = i / rungs; const rx = start.x + dx * t; const ry = start.y + dy * t;
                    const rung = createSVG("line"); rung.setAttribute("x1", rx + px); rung.setAttribute("y1", ry + py); rung.setAttribute("x2", rx - px); rung.setAttribute("y2", ry - py);
                    rung.setAttribute("stroke", "#8b4513"); rung.setAttribute("stroke-width", "4"); svg.appendChild(rung);
                }
            }

            for (let [s, e] of Object.entries(SNAKES)) {
                const head = getCellData(s); const tail = getCellData(e);
                if (!head || !tail) continue;
                const dx = tail.x - head.x; const dy = tail.y - head.y;
                const angle = Math.atan2(dy, dx);
                const px = -Math.sin(angle); const py = Math.cos(angle);
                let pathData = `M ${head.x} ${head.y}`;
                const points = 15;
                const amp = 15;
                for (let i = 1; i <= points; i++) {
                    const t = i / points;
                    const base_x = head.x + dx * t;
                    const base_y = head.y + dy * t;
                    const wave = Math.sin(t * Math.PI * 3) * amp;
                    const final_x = base_x + px * wave;
                    const final_y = base_y + py * wave;
                    pathData += ` L ${final_x} ${final_y}`;
                }
                const body = createSVG("path");
                body.setAttribute("d", pathData);
                body.setAttribute("stroke", "#15803d"); body.setAttribute("stroke-width", "12");
                body.setAttribute("fill", "none"); body.setAttribute("stroke-linecap", "round");
                svg.appendChild(body);
                const h_circ = createSVG("circle");
                h_circ.setAttribute("cx", head.x); h_circ.setAttribute("cy", head.y); h_circ.setAttribute("r", "10");
                h_circ.setAttribute("fill", "#15803d"); svg.appendChild(h_circ);
                const e1 = createSVG("circle"); e1.setAttribute("cx", head.x - 3); e1.setAttribute("cy", head.y - 2); e1.setAttribute("r", "2"); e1.setAttribute("fill", "white"); svg.appendChild(e1);
                const e2 = createSVG("circle"); e2.setAttribute("cx", head.x + 3); e2.setAttribute("cy", head.y - 2); e2.setAttribute("r", "2"); e2.setAttribute("fill", "white"); svg.appendChild(e2);
            }
        }

        document.getElementById('btn-start-game').onclick = () => {
            const rows = document.querySelectorAll('.player-row');
            players = Array.from(rows).map((row, i) => ({
                name: row.querySelector('.player-input').value || `Player ${i+1}`,
                avatar: row.querySelector('.avatar-select').value,
                type: row.dataset.type,
                pos: 1
            }));

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').style.display = 'flex';
            generateBoard();
            
            const layer = document.getElementById('tokens-layer'); layer.innerHTML = '';
            players.forEach((p, i) => {
                const t = document.createElement('div'); t.id = `p${i}`; t.className = 'token';
                t.innerHTML = `<span class="token-emoji">${p.avatar}</span><span class="token-name">${p.name}</span>`;
                layer.appendChild(t);
                
                const btn = document.getElementById(`roll-btn-${i}`);
                btn.style.display = 'flex';
                btn.querySelector('.p-label').textContent = p.name;
                btn.querySelector('.p-name').textContent = "ROLL DICE";
                btn.onclick = rollDice;
            });
            
            currentPlayerIndex = 0;
            updateStatusUI();
            updateTokenPositions();
            checkAITurn();
        };

        function updateStatusUI() {
            const activePlayer = players[currentPlayerIndex];
            
            // Update central banner
            document.getElementById('turn-banner-icon').textContent = activePlayer.avatar;
            document.getElementById('turn-banner-text').textContent = `${activePlayer.name}'s Turn`;

            players.forEach((p, i) => {
                const btn = document.getElementById(`roll-btn-${i}`);
                if (i === currentPlayerIndex) {
                    btn.classList.add('active');
                    btn.disabled = p.type === 'ai';
                    if (p.type === 'ai') {
                        btn.querySelector('.p-name').textContent = `${p.name} ROLLING...`;
                    } else {
                        btn.querySelector('.p-name').textContent = "ROLL DICE";
                    }
                } else {
                    btn.classList.remove('active');
                    btn.disabled = true;
                    btn.querySelector('.p-name').textContent = "ROLL DICE";
                }
            });
        }

        function updateTokenPositions() {
            players.forEach((p, i) => {
                const data = getCellData(p.pos);
                if (!data) return;
                const t = document.getElementById(`p${i}`);
                const offset = i * 4; 
                t.style.left = (data.left + offset) + 'px';
                t.style.top = (data.top - 15 + offset) + 'px';
            });
        }

        async function rollDice() {
            if (isMoving) return;
            isMoving = true;
            
            const overlay = document.getElementById('dice-overlay');
            const visual = document.getElementById('dice-visual');
            const msg = document.getElementById('dice-msg');
            
            overlay.style.display = 'flex';
            visual.classList.add('dice-shaking'); visual.textContent = 'üé≤';
            msg.textContent = `${players[currentPlayerIndex].name} is rolling...`;
            
            const roll = Math.floor(Math.random() * 6) + 1;
            await new Promise(r => setTimeout(r, 1000));
            
            visual.classList.remove('dice-shaking');
            visual.textContent = DICE_CHARS[roll - 1];
            msg.textContent = `${players[currentPlayerIndex].name} got ${roll}!`;
            
            await new Promise(r => setTimeout(r, 1200));
            overlay.style.display = 'none';
            
            await movePlayerSequence(roll);
        }

        async function movePlayerSequence(steps) {
            const p = players[currentPlayerIndex];
            
            if (p.pos + steps > 100) {
                const overlay = document.getElementById('dice-overlay');
                const msg = document.getElementById('dice-msg');
                const visual = document.getElementById('dice-visual');
                overlay.style.display = 'flex';
                visual.textContent = 'üö´';
                msg.textContent = `Too high! Need exactly ${100 - p.pos}!`;
                await new Promise(r => setTimeout(r, 2000));
                overlay.style.display = 'none';
                finishTurn();
                return;
            }

            for (let i = 0; i < steps; i++) {
                p.pos++;
                updateTokenPositions();
                await new Promise(r => setTimeout(r, 300));
            }

            let jumped = false;
            if (LADDERS[p.pos]) { await new Promise(r => setTimeout(r, 500)); p.pos = LADDERS[p.pos]; jumped = true; }
            else if (SNAKES[p.pos]) { await new Promise(r => setTimeout(r, 500)); p.pos = SNAKES[p.pos]; jumped = true; }

            if (jumped) { updateTokenPositions(); await new Promise(r => setTimeout(r, 600)); }

            if (p.pos === 100) {
                document.getElementById('win-text').textContent = `${p.name} Wins!`;
                document.getElementById('win-overlay').style.display = 'flex';
            } else {
                finishTurn();
            }
        }

        function finishTurn() {
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            updateStatusUI();
            isMoving = false;
            checkAITurn();
        }

        function checkAITurn() {
            const p = players[currentPlayerIndex];
            if (p.type === 'ai' && !isMoving) setTimeout(rollDice, 1800); 
        }

        document.getElementById('btn-reload').onclick = () => location.reload();
        window.onresize = () => { if (players.length > 0) { drawGraphics(); updateTokenPositions(); } };
    </script>
</body>
</html>
